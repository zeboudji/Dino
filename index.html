// Fonction principale de la boucle de jeu
let obstacleTimer = 0;
function gameLoop() {
    if (gameOver || gameWin) {
        console.log("Exiting gameLoop: gameOver =", gameOver, "gameWin =", gameWin);
        return; // Arrêter la boucle de jeu
    }

    // Effacer le canvas
    ctx.clearRect(0, 0, WIDTH, HEIGHT);

    // Dessiner le sol
    ctx.fillStyle = "#000000";
    ctx.fillRect(0, GROUND_Y, WIDTH, 4); // Sol légèrement plus épais

    // Gérer le saut
    dino.velocityY += GRAVITY;
    dino.y += dino.velocityY;

    // Log de la position du dinosaure
    console.log(`Dino position Y: ${dino.y.toFixed(2)}, VelocityY: ${dino.velocityY.toFixed(2)}, isJumping: ${dino.isJumping}`);

    if (dino.y >= GROUND_Y - dino.height) {
        dino.y = GROUND_Y - dino.height;
        dino.isJumping = false;
        dino.velocityY = 0;
        console.log("Dino atterri");
    }

    // Mettre à jour la position du coach
    coach.x = dino.x + dino.width / 2 - coach.width / 2;
    coach.y = dino.y - coach.height - 10;

    // Dessiner le dinosaure
    if (dinoImg.complete) {
        ctx.drawImage(dinoImg, dino.x, dino.y, dino.width, dino.height);
    }

    // Dessiner le coach volant "Inside"
    if (coachImg.complete) {
        ctx.drawImage(coachImg, coach.x, coach.y, coach.width, coach.height);
    }

    // Ajouter le texte "Coach Y.ZEBOUDJI" au-dessus du coach
    ctx.fillStyle = "#000000"; // Noir
    ctx.font = "16px Arial"; // Taille augmentée pour meilleure lisibilité
    ctx.textAlign = "center";
    ctx.fillText("Coach Y.ZEBOUDJI", coach.x + coach.width / 2, coach.y - 10); // Position ajustée au-dessus du coach

    // Gérer les obstacles
    obstacleTimer++;
    // Calculer le seuil d'obstacle avec un minimum pour éviter un espacement trop court
    const dynamicObstacleTimerThreshold = Math.max(
        MIN_OBSTACLE_TIMER_THRESHOLD,
        BASE_OBSTACLE_TIMER_THRESHOLD - Math.floor(score / 100)
    );
    if (obstacleTimer > dynamicObstacleTimerThreshold) {
        createObstacle();
        obstacleTimer = 0;
        updatePreview();
    }

    // Dessiner et mettre à jour les obstacles
    for (let i = 0; i < obstacles.length; i++) {
        let obs = obstacles[i];
        const currentSpeed = OBSTACLE_SPEED + Math.floor(score / 100) * 0.2;
        obs.x -= currentSpeed; // Augmenter la vitesse avec le score

        // Dessiner l'obstacle avec son image spécifique
        if (obs.image.complete) {
            ctx.drawImage(obs.image, obs.x, obs.y, obs.width, obs.height);
        }

        // Dessiner l'étiquette IA sous l'obstacle
        ctx.fillStyle = "#000000"; // Noir
        ctx.font = "16px Arial"; // Taille augmentée pour meilleure lisibilité
        ctx.textAlign = "center";
        ctx.fillText(obs.label, obs.x + obs.width / 2, obs.y + obs.height + 20); // Position ajustée

        // Détecter les collisions
        let dinoRect = {x: dino.x, y: dino.y, width: dino.width, height: dino.height};
        let obsRect = {x: obs.x, y: obs.y, width: obs.width, height: obs.height};
        if (detectCollision(dinoRect, obsRect)) {
            gameOver = true;
            gameOverReason = obs.label; // Stocker le label de l'obstacle causant la collision
            gameOverElement.style.display = 'block';
            restartButton.style.display = 'block';
            gameOverReasonElement.textContent = gameOverReason; // Afficher le label dans le message Game Over
            console.log(`Collision détectée avec ${gameOverReason}`);
        }

        // Vérifier si l'obstacle a été passé
        if (!obs.passed && obs.x + obs.width < dino.x) {
            obs.passed = true;
            updatePreview(); // Mettre à jour l'aperçu après avoir passé l'obstacle
        }

        // Supprimer les obstacles hors écran
        if (obs.x + obs.width < 0) {
            obstacles.splice(i, 1);
            i--;
        }
    }

    // Mettre à jour le score
    score++;
    scoreElement.textContent = `Score: ${score}`;
    console.log(`Score updated: ${score}`);

    // Vérifier les conditions de victoire
    if (score >= 1000 && victoryStage === 0) {
        victoryStage = 1;
        gameWinElement.innerHTML = `
            <h1>Félicitations !</h1>
            <p>Vous avez atteint 10 000 points et gagné 30 minutes d'acculturation avec le coach !</p>
            <img src="images/coach.png" alt="Coach" id="coachImage">
        `;
        gameWinElement.style.display = 'block';
        restartButton.style.display = 'block';
        restartButton.textContent = 'Continuer';
        console.log("Félicitations ! Vous avez atteint 10 000 points.");
        return; // Arrêter la boucle de jeu
    }

    if (score >= 1500 && victoryStage === 1) {
        victoryStage = 2;
        gameWinElement.innerHTML = `
            <h1>Félicitations !</h1>
            <p>Vous avez atteint 15 000 points et gagné 1h d'acculturation avec le coach !</p>
            <img src="images/coach.png" alt="Coach" id="coachImage">
        `;
        gameWinElement.style.display = 'block';
        restartButton.style.display = 'block';
        restartButton.textContent = 'Redémarrer';
        console.log("Félicitations ! Vous avez atteint 15 000 points.");
        return; // Arrêter la boucle de jeu
    }

    // Appeler la prochaine frame
    requestAnimationFrame(gameLoop);
}
